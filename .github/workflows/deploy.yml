name: ğŸš€ Deploy FastAPI App to aaPanel with Logs

on:
  push:
    branches:
      - main  # Trigger deployment when code is pushed to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ§¾ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ§  Show Environment Info
      run: |
        echo "=== SYSTEM INFO ==="
        uname -a
        echo "Python version:"
        python3 --version || echo "Python not installed"
        echo "Current working directory: $(pwd)"
        echo "Repository files (first 50):"
        ls -R | head -50

    - name: ğŸš€ Start Deployment via SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2232
        script_stop: true   # stop on first error
        debug: true         # enable detailed ssh debug logs
        script: |
          set -e  # stop script on any command failure

          echo "=== ğŸŸ¢ Connected to Server ==="
          uname -a
          echo "Current path: $(pwd)"
          echo "Listing top-level directories..."
          ls -al /

          echo "=== ğŸ” Validating Deployment Path ==="
          if [ ! -d "/www/wwwroot/JHS_TCD" ]; then
            echo "âŒ ERROR: /www/wwwroot/JHS_TCD not found. Listing /www/wwwroot:"
            ls -al /www/wwwroot || { echo "âŒ ERROR: /www/wwwroot missing entirely"; exit 1; }
            exit 1
          fi

          cd /www/wwwroot/JHS_TCD
          echo "âœ… Entered $(pwd)"
          echo "Listing files:"
          ls -al

          echo "=== ğŸ” Pulling Latest Code from GitHub ==="
          git status || echo "âš ï¸ Warning: Git repo not initialized"
          git fetch origin main || { echo "âŒ ERROR: Git fetch failed"; exit 1; }
          git reset --hard origin/main || { echo "âŒ ERROR: Git reset failed"; exit 1; }
          echo "âœ… Latest commit:"
          git log -1 --oneline

          echo "=== ğŸ Activating or Creating Virtual Environment ==="
          if [ -d "venv" ]; then
            echo "Found existing venv. Activating..."
            source venv/bin/activate
          else
            echo "Creating a new virtual environment..."
            python3 -m venv venv || { echo "âŒ ERROR: Failed to create venv"; exit 1; }
            source venv/bin/activate
          fi
          python --version

          echo "=== ğŸ“¦ Installing Dependencies ==="
          pip install --upgrade pip
          pip install -r requirements.txt || { echo "âŒ ERROR: Requirements installation failed"; exit 1; }
          echo "âœ… Dependencies installed successfully."

          echo "=== ğŸ” Restarting Supervisor Process ==="
          supervisorctl reread || echo "âš ï¸ Warning: reread failed"
          supervisorctl update || echo "âš ï¸ Warning: update failed"
          supervisorctl restart JHS_TCD || { echo "âŒ ERROR: Supervisor restart failed"; exit 1; }

          echo "=== ğŸ” Checking Supervisor Status ==="
          supervisorctl status JHS_TCD || echo "âš ï¸ Could not verify supervisor process"

          echo "=== âœ… Deployment Complete ==="
