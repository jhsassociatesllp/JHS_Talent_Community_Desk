name: ğŸš€ Deploy FastAPI App to aaPanel with Logs

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ§¾ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ§  Show Environment Info
      run: |
        echo "=== SYSTEM INFO ==="
        uname -a
        echo "Python version:"
        python3 --version || echo "Python not installed"
        echo "Repository files (first 50):"
        ls -R | head -50

    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2232
        script_stop: false
        debug: true
        script: |
          echo "=== ğŸŸ¢ Connected to Server ==="
          cd /www/wwwroot/JHS_TCD || { echo "âŒ ERROR: Path not found"; exit 1; }
          echo "âœ… Entered $(pwd)"
          ls -al

          echo "=== ğŸ§¹ Fixing Ownership (ensures root can read repo) ==="
          chown -R root:root /www/wwwroot/JHS_TCD || echo "âš ï¸ Ownership change skipped"

          echo "=== ğŸ”’ Marking directory safe for git ==="
          git config --global --add safe.directory /www/wwwroot/JHS_TCD

          echo "=== ğŸ” Checking and Updating Repository ==="
          if [ ! -d ".git" ]; then
            echo "âš ï¸ No Git repo found â€” cloning fresh..."
            rm -rf *
            git clone https://github.com/jhsassociatesllp/JHS_Talent_Community_Desk.git .
            echo "âœ… Repo cloned successfully!"
          else
            echo "âœ… Repo already initialized, trying to pull..."
            git status || echo "âš ï¸ Git status failed, continuing..."
            git fetch origin main || { echo "âŒ Git fetch failed"; git config --global --add safe.directory /www/wwwroot/JHS_TCD; exit 1; }
            git reset --hard origin/main || { echo "âŒ Git reset failed"; exit 1; }
          fi

          echo "âœ… Latest commit:"
          git log -1 --oneline || echo "âš ï¸ Could not show latest commit"

          echo "=== ğŸ Virtual Environment ==="
          if [ -d "venv" ]; then
            source venv/bin/activate
          else
            python3 -m venv venv && source venv/bin/activate
          fi
          python --version

          echo "=== ğŸ“¦ Installing Dependencies ==="
          pip install --upgrade pip
          pip install -r requirements.txt || { echo "âŒ Pip install failed"; exit 1; }
          echo "âœ… Dependencies installed"

          echo "=== ğŸ” Restarting Supervisor ==="
          supervisorctl reread || true
          supervisorctl update || true
          supervisorctl restart JHS_TCD || true

          echo "=== âœ… Deployment Complete ==="
